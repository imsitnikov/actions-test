import React from 'react';
import { ChevronDown, TriangleExclamation } from '@gravity-ui/icons';
import isEmpty from 'lodash/isEmpty';
import { useUniqId } from '../../../../hooks';
import { Icon } from '../../../Icon';
import { Popover } from '../../../Popover';
import { selectControlBlock, selectControlButtonBlock } from '../../constants';
import i18n from '../../i18n';
import { SelectClear } from '../SelectClear/SelectClear';
import { SelectCounter } from '../SelectCounter/SelectCounter';
import './SelectControl.css';
export const SelectControl = React.forwardRef((props, ref) => {
    const { toggleOpen, clearValue, onKeyDown, renderControl, view, size, pin, selectedOptionsContent, className, qa, name, label, placeholder, isErrorVisible, errorMessage, open, disabled, value, hasClear, popupId, selectId, activeIndex, renderCounter, hasCounter, title, } = props;
    const showOptionsText = Boolean(selectedOptionsContent);
    const showPlaceholder = Boolean(placeholder && !showOptionsText);
    const hasValue = Array.isArray(value) && !isEmpty(value.filter(Boolean));
    const errorTooltipId = useUniqId();
    const [isDisabledButtonAnimation, setIsDisabledButtonAnimation] = React.useState(false);
    const controlMods = {
        open,
        size,
        pin,
        disabled,
        error: isErrorVisible,
        'has-clear': hasClear,
        'no-active': isDisabledButtonAnimation,
        'has-value': hasValue,
    };
    const buttonMods = {
        open,
        size,
        view,
        pin,
        disabled,
        error: isErrorVisible,
    };
    const handleControlClick = React.useCallback((e) => {
        // Fix for Safari
        // https://developer.mozilla.org/en-US/docs/Web/HTML/Element/button#clicking_and_focus
        if (e && e.currentTarget !== document.activeElement && 'focus' in e.currentTarget) {
            e.currentTarget.focus();
        }
        toggleOpen();
    }, [toggleOpen]);
    const disableButtonAnimation = React.useCallback(() => {
        setIsDisabledButtonAnimation(true);
    }, []);
    const enableButtonAnimation = React.useCallback(() => {
        setIsDisabledButtonAnimation(false);
    }, []);
    const handleOnClearIconClick = React.useCallback(() => {
        // return animation on clear click
        setIsDisabledButtonAnimation(false);
        clearValue();
    }, [clearValue]);
    const renderCounterComponent = () => {
        if (!hasCounter) {
            return null;
        }
        const count = Number(value === null || value === void 0 ? void 0 : value.length) || 0;
        const counterComponent = React.createElement(SelectCounter, { count: count, size: size, disabled: disabled });
        return renderCounter
            ? renderCounter(counterComponent, { count, size, disabled })
            : counterComponent;
    };
    const renderClearIcon = (args) => {
        const hideOnEmpty = !(value === null || value === void 0 ? void 0 : value[0]);
        if (!hasClear || !clearValue || hideOnEmpty || disabled) {
            return null;
        }
        return (React.createElement(SelectClear, { size: size, onClick: handleOnClearIconClick, onMouseEnter: disableButtonAnimation, onMouseLeave: enableButtonAnimation, renderIcon: args.renderIcon }));
    };
    if (renderControl) {
        return renderControl({
            onKeyDown,
            onClear: clearValue,
            onClick: handleControlClick,
            renderClear: (arg) => renderClearIcon(arg),
            renderCounter: renderCounterComponent,
            ref,
            open: Boolean(open),
            popupId,
            selectId,
            activeIndex,
        }, { value });
    }
    return (React.createElement(React.Fragment, null,
        React.createElement("div", { className: selectControlBlock(controlMods), role: "group" },
            React.createElement("button", { ref: ref, role: "combobox", "aria-controls": popupId, className: selectControlButtonBlock(buttonMods, className), "aria-haspopup": "listbox", "aria-expanded": open, "aria-activedescendant": activeIndex === undefined
                    ? undefined
                    : `${selectId}-list-item-${activeIndex}`, name: name, disabled: disabled, onClick: handleControlClick, onKeyDown: onKeyDown, type: "button", "data-qa": qa, title: title },
                label && React.createElement("span", { className: selectControlBlock('label') }, label),
                showPlaceholder && (React.createElement("span", { className: selectControlBlock('placeholder') }, placeholder)),
                showOptionsText && (React.createElement("span", { className: selectControlBlock('option-text') }, selectedOptionsContent))),
            renderCounterComponent(),
            renderClearIcon({}),
            errorMessage && (React.createElement(Popover, { content: errorMessage, tooltipId: errorTooltipId },
                React.createElement("button", { "aria-label": i18n('label_show-error-info'), "aria-describedby": errorTooltipId, className: selectControlBlock('error-icon') },
                    React.createElement(Icon, { data: TriangleExclamation, size: size === 's' ? 12 : 16 })))),
            React.createElement(Icon, { className: selectControlBlock('chevron-icon', { disabled }), data: ChevronDown, "aria-hidden": "true" }))));
});
SelectControl.displayName = 'SelectControl';
