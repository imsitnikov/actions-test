import React from 'react';
import { Modal } from '@gravity-ui/uikit';
import { block } from '../utils/cn';
import { IndexType, StoriesLayout } from './components/StoriesLayout/StoriesLayout';
import { useSyncWithLS } from './hooks';
import './Stories.css';
const b = block('stories');
export function Stories({ open, onClose, items, onPreviousClick, onNextClick, initialStoryIndex = 0, disableOutsideClick = true, className, action, syncInTabsKey, }) {
    const [storyIndex, setStoryIndex] = React.useState(initialStoryIndex);
    const handleClose = React.useCallback((event, reason) => {
        onClose === null || onClose === void 0 ? void 0 : onClose(event, reason);
    }, [onClose]);
    const { callback: closeWithLS } = useSyncWithLS({
        callback: (event, reason) => {
            onClose === null || onClose === void 0 ? void 0 : onClose(event, reason);
        },
        uniqueKey: `close-story-${syncInTabsKey}`,
    });
    const handleButtonClose = React.useCallback((event) => {
        handleClose(event, 'closeButtonClick');
        if (syncInTabsKey)
            closeWithLS(event, 'closeButtonClick');
    }, [handleClose, syncInTabsKey, closeWithLS]);
    const handleGotoPrevious = React.useCallback(() => {
        setStoryIndex((currentStoryIndex) => {
            if (currentStoryIndex <= 0) {
                return 0;
            }
            const newIndex = currentStoryIndex - 1;
            onPreviousClick === null || onPreviousClick === void 0 ? void 0 : onPreviousClick(newIndex);
            return newIndex;
        });
    }, [onPreviousClick]);
    const handleGotoNext = React.useCallback(() => {
        setStoryIndex((currentStoryIndex) => {
            if (currentStoryIndex >= items.length - 1) {
                return items.length - 1;
            }
            const newIndex = currentStoryIndex + 1;
            onNextClick === null || onNextClick === void 0 ? void 0 : onNextClick(newIndex);
            return newIndex;
        });
    }, [items, onNextClick]);
    if (items.length === 0) {
        return null;
    }
    // case when items has changed and index has ceased to be valid
    if (items[storyIndex] === undefined) {
        const correctIndex = items[initialStoryIndex] === undefined ? 0 : initialStoryIndex;
        setStoryIndex(correctIndex);
        return null;
    }
    const indexType = (items.length === 1 && IndexType.Single) ||
        (storyIndex === 0 && IndexType.Start) ||
        (storyIndex === items.length - 1 && IndexType.End) ||
        IndexType.InProccess;
    return (React.createElement(Modal, { open: open, onClose: handleClose, disableOutsideClick: disableOutsideClick, className: b(), contentClassName: b('modal-content', className) },
        React.createElement(StoriesLayout, { items: items, storyIndex: storyIndex, indexType: indexType, handleButtonClose: handleButtonClose, handleGotoNext: handleGotoNext, handleGotoPrevious: handleGotoPrevious, action: action })));
}
